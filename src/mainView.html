<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VSCode - Improving Find Extension</title>
    <style>
      * {
        /* border: 1px solid black; */
        box-sizing: border-box;
      }
      div.viewport {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 50px);
        max-height: calc(100vh - 50px);
      }
      div.search-results {
        display: flex;
        flex-direction: row;
        flex-grow: 1;
        justify-content: space-around;
      }
      div.file-list {
        box-sizing: border-box;
        flex: 0 0 45%;
      }
      select.file-list {
        width: 100%;
      }
      div.file-content {
        box-sizing: border-box;
        flex: 0 0 45%;
        overflow: scroll;
        white-space: nowrap;
      }
      /* https://code.visualstudio.com/api/references/theme-color */
      span.code {
        font-family: var(--vscode-editor-font-family);
        font-size: var(--vscode-editor-font-size);
        white-space: pre;
      }
      span.code-context {
        color: lightgray;
      }
      span.code-match {
        color: greenyellow;
      }
      div.search-bar {
        width: 100%;
      }
      input#search-input {
        display: block;
        width: 100%;
        margin: auto;
        font-size: 18px;
        font-weight: 600;
        /* color: #4b00ff; */
        padding: 10px;
        /* border: 2px solid #4b00ff; */
      }
      div.info-display {
        display: flex;
        flex-direction: row;
        padding: 10px;
        width: 100%;
      }
      div#info-display-hint {
        visibility: visible;
        width: 50%;
      }
      div#info-display-error {
        text-align: right;
        visibility: hidden;
        width: 50%;
      }
    </style>
  </head>
  <body onload="onBodyLoad()">
    <div class="viewport">
      <div class="search-bar">
        <input
          id="search-input"
          type="text"
          oninput="onSearchBarInput(this.value)"
          onkeydown="onSearchBarKeyDown()"
        />
      </div>
      <div class="info-display">
        <div id="info-display-hint">
          <p>3 more letters</p>
        </div>
        <div id="info-display-error">
          <p>Something went wrong</p>
        </div>
      </div>
      <div class="search-results">
        <div id="file-list" class="file-list">
          <select
            id="file-list-selection"
            size="10"
            class="file-list"
            onchange="onFileSelectionChange(this.value)"
          >
            <option value="one">one</option>
            <option value="two">two</option>
            <option value="three">three</option>
            <option value="four">four</option>
            <option value="five">five</option>
            <option value="six">six</option>
            <option value="seven">seven</option>
            <option value="eight">eight</option>
            <option value="nine">nine</option>
            <option value="ten">ten</option>
            <option value="eleven">eleven</option>
          </select>
        </div>
        <div id="selected-file-content" class="file-content">
          <span class="code-context">25</span><br />
          <span class="code-context">
            26 * You can open the full set of our API when you open the file
            `node_modules/@types/vscode/index.d.ts`. </span
          ><br />
          <span class="code-context">27</span><br />
          <span class="code-match">28 ## Run tests</span><br />
          <span class="code-context">29</span><br />
          <span class="code-context">
            30 * Open the debug viewlet (`Ctrl+Shift+D` or `Cmd+Shift+D` on Mac)
            and from the launch configuration dropdown pick `Extension Tests`. </span
          ><br />
          <span class="code-match">
            31 * Press `F5` to run the tests in a new window with your extension
            loaded. </span
          ><br />
          <span class="code-match">
            32 * See the output of the test result in the debug console. </span
          ><br />
          <span class="code-match">
            33 * Make changes to `src/test/suite/extension.test.ts` or create
            new test files inside the `test/suite` folder. </span
          ><br />
          <span class="code-match">
            34 * The provided test runner will only consider files matching the
            name pattern `**.test.ts`. </span
          ><br />
          <span class="code-match">
            35 * You can create folders inside the `test` folder to structure
            your tests any way you want. </span
          ><br />
          <span class="code-match">
            35 * You can create folders inside the `test` folder to structure
            your tests any way you want. </span
          ><br />
          <span class="code-match">
            35 * You can create folders inside the `test` folder to structure
            your tests any way you want. </span
          ><br />
          <span class="code-match">
            35 * You can create folders inside the `test` folder to structure
            your tests any way you want. </span
          ><br />
          <span class="code-context">36</span><br />
          <span class="code-context">37 ## Go further</span><br />
          <span class="code-context">38</span><br />
        </div>
      </div>
    </div>

    <script>
      const vscode = acquireVsCodeApiOrMock();

      var globalResultCache = null;

      // message handler for events from the VSCode
      window.addEventListener("message", handleVSCodeEvent);

      //======================================================================
      // FUNCTIONS
      //======================================================================

      function acquireVsCodeApiOrMock() {
        if (typeof acquireVsCodeApi !== "undefined") {
          return acquireVsCodeApi();
        }

        const mock = {};
        mock.postMessage = (msg) => {};
        mock.getState = () => {
          return undefined;
        };
        mock.setState = (data) => {};
        return mock;
      }

      function handleVSCodeEvent(event) {
        // has `window` property as implicitly bound context
        const message = event.data;
        switch (message.type) {
          case "find-result":
            handleFindResult(message.result);
            break;
          default:
            console.log(`handleVSCodeEvent(): event=${JSON.stringify(event)}`);
            break;
        }
      }

      function onBodyLoad() {
        document.getElementById("search-input").focus();
      }

      function onSearchBarInput(inputValue) {
        console.log(`onSearchBarInput(): inputValue=${inputValue}`);

        const sanitizeInput = (str) => {
          return str.trim();
        };

        const sanitizedInputValue = sanitizeInput(inputValue);
        console.log(
          `onSearchBarInput(): sanitizedInputValue=${sanitizedInputValue}`
        );

        if (sanitizedInputValue.length < 3) {
          return;
        }

        vscode.postMessage({
          type: "find-input-change",
          input: inputValue,
        });
      }

      function onSearchBarKeyDown() {
        const KEY_UP = 38;
        const KEY_DOWN = 40;
        const KEY_ENTER = 13;
        const KEY_ESCAPE = 27;

        console.log(`onSearchBarKeyDown(): keyCode=${event.keyCode}`);

        // select.selectedIndex starts at 0;
        // -1 would deselect all options (if any)
        const element = document.getElementById("file-list-selection");
        switch (event.keyCode) {
          case KEY_UP:
            let selectedIndex = element.selectedIndex - 1;
            selectedIndex =
              selectedIndex < 0 ? element.length - 1 : selectedIndex;
            element.selectedIndex = selectedIndex;
            event.preventDefault(); // prevent search bar from handling the input
            break;
          case KEY_DOWN:
            element.selectedIndex =
              (element.selectedIndex + 1) % element.length;
            event.preventDefault(); // prevent search bar from handling the input
            break;
          case KEY_ENTER:
            const selectedFilePath = element.value;
            onFileSelectionOpen(selectedFilePath);
            break;
          case KEY_ESCAPE:
            onCloseExtensionView();
            break;
          default:
            // do nothing
            break;
        }

        // changing the selection with JS does not trigger onchange event;
        // we simulate it with this
        onFileSelectionChange(element.value);
      }

      function onFileSelectionChange(selectedValue) {
        console.log(`onFileSelectionChange(): selectedValue=${selectedValue}`);
        if (globalResultCache) {
          const resultFile = globalResultCache[selectedValue];
          updateFileContent(resultFile);
        }
      }

      function updateFileContent(resultFile) {
        const parentElement = document.getElementById("selected-file-content");

        // clear all content first
        parentElement.replaceChildren();

        let previousLineNumber = 0;
        for (let line of resultFile.lines) {
          // render a separator line if the difference between current and
          // previous line numbers is more than 1
          if (
            previousLineNumber > 0 &&
            line.lineNumber - previousLineNumber > 1
          ) {
            renderLineContent("---\n", parentElement, "code code-context");
          }

          const className =
            line.type === "match" ? "code code-match" : "code code-context";
          renderLineContent(
            `${line.lineNumber} ${line.content}`,
            parentElement,
            className
          );

          previousLineNumber = line.lineNumber;
        }
      }

      function renderLineContent(str, parentElement, className) {
        const childElement = document.createElement("span");
        childElement.className = className;
        childElement.innerHTML = escapeHtml(str);

        parentElement.appendChild(childElement);
      }

      function escapeHtml(str) {
        const p = document.createElement("p");
        p.appendChild(document.createTextNode(str));
        return p.innerHTML;
      }

      function onFileSelectionOpen(selectedFilePath) {
        console.log(
          `onFileSelectionOpen(): selectedFilePath=${selectedFilePath}`
        );

        if (selectedFilePath) {
          vscode.postMessage({
            type: "file-selected",
            path: selectedFilePath,
          });
        }
      }

      function handleFindResult(result) {
        globalResultCache = result;
        updateFileList(result);
        selectFirstFileInList();
      }

      function updateFileList(result) {
        const parentElement = document.getElementById("file-list-selection");
        parentElement.replaceChildren();

        for (let key in result) {
          const resultFile = result[key];
          const childElement = document.createElement("option");
          childElement.value = resultFile.filePath;
          childElement.innerHTML = resultFile.filePath;
          parentElement.appendChild(childElement);
        }
      }

      function selectFirstFileInList() {
        const element = document.getElementById("file-list-selection");
        element.selectedIndex = 0;
        onFileSelectionChange(element.value);
      }

      function onCloseExtensionView() {
        vscode.postMessage({
          type: "close-extension-view",
        });
      }
    </script>
  </body>
</html>
