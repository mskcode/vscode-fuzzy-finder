<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VSCode - Improving Find Extension</title>
    <style>
      * {
        border: 1px solid black;
        box-sizing: border-box;
      }
      div.file-list {
        float: left;
        width: 50%;
        padding: 50px;
      }
      select.file-list {
        width: 100%;
      }
      .file-content {
        float: right;
        width: 50%;
        padding: 50px;
      }
      div.search-bar {
        width: 100%;
      }
      input#search-input {
        display: block;
        width: calc(100% - 24px);
        margin: auto;
        font-size: 18px;
        font-weight: 600;
        /* color: #4b00ff; */
        padding: 10px;
        /* border: 2px solid #4b00ff; */
      }
    </style>
  </head>
  <body onload="onBodyLoad()">
    <div class="search-bar">
      <input
        id="search-input"
        type="text"
        oninput="onSearchBarInput(this.value)"
        onkeydown="onSearchBarKeyDown()"
      />
    </div>
    <div>
      <div id="file-list" class="file-list">
        <select
          id="file-list-selection"
          size="10"
          class="file-list"
          onchange="onFileSelectionChange(this.value)"
        >
          <option value="one">one</option>
          <option value="two">two</option>
          <option value="three">three</option>
          <option value="four">four</option>
          <option value="five">five</option>
          <option value="six">six</option>
          <option value="seven">seven</option>
          <option value="eight">eight</option>
          <option value="nine">nine</option>
          <option value="ten">ten</option>
          <option value="eleven">eleven</option>
        </select>
      </div>
      <div id="selected-file-content" class="file-content">
        <code>
          Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do
          eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad
          minim veniam, quis nostrud exercitation ullamco laboris nisi ut
          aliquip ex ea commodo consequat. Duis aute irure dolor in
          reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla
          pariatur. Excepteur sint occaecat cupidatat non proident, sunt in
          culpa qui officia deserunt mollit anim id est laborum.
        </code>
      </div>
    </div>

    <script>
      const vscode = acquireVsCodeApi();
      //const vscode = undefined;

      let globalResultCache = null;

      function onBodyLoad() {
        document.getElementById("search-input").focus();
      }

      function onSearchBarInput(inputValue) {
        //console.log(`onSearchBarInput(): inputValue=${inputValue}`);

        const sanitizeInput = (str) => {
          return str.trim();
        };

        const sanitizedInputValue = sanitizeInput(inputValue);
        console.log(
          `onSearchBarInput(): sanitizedInputValue=${sanitizedInputValue}`
        );

        if (sanitizedInputValue.length < 3) {
          return;
        }

        vscode.postMessage({
          type: "find-input-change",
          input: inputValue,
        });
      }

      function onSearchBarKeyDown() {
        const KEY_UP = 38;
        const KEY_DOWN = 40;

        // console.log(`onSearchBarKeyDown(): keyCode=${event.keyCode}`);

        // select.selectedIndex starts at 0;
        // -1 would deselect all options (if any)
        const element = document.getElementById("file-list-selection");
        switch (event.keyCode) {
          case KEY_UP:
            let selectedIndex = element.selectedIndex - 1;
            selectedIndex =
              selectedIndex < 0 ? element.length - 1 : selectedIndex;
            element.selectedIndex = selectedIndex;
            break;
          case KEY_DOWN:
            element.selectedIndex =
              (element.selectedIndex + 1) % element.length;
            break;
          default:
            // do nothing
            break;
        }

        // changing the selection with JS does not trigger onchange event;
        // we simulate it with this
        onFileSelectionChange(element.value);
      }

      function onFileSelectionChange(selectedValue) {
        console.log(`onFileSelectionChange(): selectedValue=${selectedValue}`);
        if (globalResultCache) {
          const resultFile = globalResultCache[selectedValue];
          updateFileContent(resultFile);
        }
      }

      function updateFileContent(resultFile) {
        const parentElement = document.getElementById("selected-file-content");
        parentElement.replaceChildren();

        const childElement = document.createElement("code");
        childElement.innerHTML = JSON.stringify(resultFile.lines); // FIXME

        parentElement.appendChild(childElement);
      }

      function handleFindResult(result) {
        globalResultCache = result;
        updateFileList(result);
        selectFirstFileInList();
      }

      function updateFileList(result) {
        const parentElement = document.getElementById("file-list-selection");
        parentElement.replaceChildren();

        for (let key in result) {
          const resultFile = result[key];
          const childElement = document.createElement("option");
          childElement.value = resultFile.filePath;
          childElement.innerHTML = resultFile.filePath;
          parentElement.appendChild(childElement);
        }
      }

      function selectFirstFileInList() {
        const element = document.getElementById("file-list-selection");
        element.selectedIndex = 0;
        onFileSelectionChange(element.value);
      }

      // message handler for events from the VSCode
      window.addEventListener("message", (event) => {
        const message = event.data;
        switch (message.type) {
          case "find-result":
            handleFindResult(message.result);
            break;
        }
      });
    </script>
  </body>
</html>
